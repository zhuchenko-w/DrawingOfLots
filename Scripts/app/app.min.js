var textAreaValueUpdating=false;var textAreaValueChanged=false;$(function(){$(".values-switch").on("change",function(){var a=$(this);if(a.is(":checked")){showValues(valueLists[a.data("list-name")])}});$(".results").on("click",".btn-download-csv",function(){CommonHelper.DownloadCsv("Жеребьевка.csv",getResultCsvText())});$(".results").on("click",".btn-copy-all",function(){var a=$(".results .result-group");ClipboardHelper.CopyTextToClipboard(getResultCsvText(),function(){indicateCopyToClipboardResult(a,true)},function(){indicateCopyToClipboardResult(a,false)})});$(".results").on("click",".btn-copy-group",function(){var a=$(this).closest(".result-group");ClipboardHelper.CopyTextToClipboard(getResultGroupCsvText(a),function(){indicateCopyToClipboardResult(a,true)},function(){indicateCopyToClipboardResult(a,false)})});$(".start-btn").click(draw);$(".buttons").on("click",".load-saved-result-btn",function(){loadResults($(this).data("key"))}).on("click",".remove-all-saved-results-btn",function(){removeAllSavedResults()}).on("click",".remove-saved-result-btn",function(){var a=$(this);removeSavedResult(a,a.data("key"));return false});$(".values").on("change input",function(){textAreaValueChanged=true;updateFilterAndIndicator(!textAreaValueUpdating)});$(".values").on("focusout",function(){if(textAreaValueChanged){textAreaValueChanged=false;updateFilterAndIndicator()}});fillPreviousResultsMenu();createNumberOfGroupsOptions();initSelect2();showValues(valueLists.allCountries)});function createNumberOfGroupsOptions(){var a=1;while(a++<11){$(".number-of-groups").append($("<option value='"+a+"'"+(a==4?"selected":"")+">"+a+" штук"+(a>4?"":"и")+"</option>"))}}function fillPreviousResultsMenu(){var b=DataStorageHelper.ReadLocal(ResultsKeysKey);if(b&&b.length>0){var a="";$.each(b,function(c,d){a+='<div class="dropdown-item saved-results-menu-item load-saved-result-btn" data-key="'+d+'">'+d+'</div><button class="btn btn-danger btn-sm remove-saved-result-btn" data-key="'+d+'"></button>'});a+='<div class="dropdown-divider"></div><div class="dropdown-item saved-results-menu-item remove-all-saved-results-btn">Очистить сохраненные</div>';$(".saved-results-menu").html(a);$(".saved-results-dropdown").show()}else{$(".saved-results-dropdown").hide()}}function initSelect2(){$(".multiselect").select2({language:"ru",width:"280px",allowClear:true,multiple:true,closeOnSelect:false,dropdownCssClass:"multiselect-dropdown",placeholder:"Все"}).on("select2:close",function(){if($(this).val().length>0){$(".values").prop("readonly",true)}else{$(".values").prop("readonly",false)}updateFilterAndIndicator(true)})}function updateFilterAndIndicator(a){var b=getDistinctValues();if(b.length==0){if(!a){setFilter(null)}$(".lines-count").text("");$(".start-btn").prop("disabled",true)}else{if(!a){setFilter(b)}$(".lines-count").text("("+b.length+") ");$(".start-btn").prop("disabled",false)}}function setFilter(b){$(".items-select option:not(.all-option)").remove();if(b!=null){var a="";$.each(b,function(c,d){a+="<option value='"+d+"'>"+d+"</option>"});$(".items-select").append($(a))}}function getDistinctValues(){return $(".values").prop("readonly")?$(".multiselect").val():CommonHelper.Distinct($(".values").val().split(/\r|\r\n|\n/).filter(function(a){return a.replace(/\s/g,"")!==""}))}function getValues(){return $(".values").prop("readonly")?$(".multiselect").val():$(".values").val().split(/\r|\r\n|\n/).filter(function(a){return a.replace(/\s/g,"")!==""})}function showValues(a){textAreaValueUpdating=true;var b=$(".values");b.prop("readonly",false);if(a==null){b.val("").change()}else{b.val(a.join("\n")).change()}textAreaValueUpdating=false}function getResultCsvText(){var b=$(".results .result-group");var a=[];$.each(b,function(c,d){a.push(getResultGroupCsvText(d))});return a.join("\r\n")}function getResultGroupCsvText(b){var c=$(".list-group-item",b);var a=[];$.each(c,function(d,e){a.push(e.innerText)});return a.join("\t")}function indicateCopyToClipboardResult(b,a){var c=a?"copied":"copy-error";b.removeClass("copied");b.removeClass("copy-error");b.addClass(c);setTimeout(function(){b.removeClass(c)},300)}function loading(a){if(a){$(".loader-wrap").show()}else{$(".loader-wrap").hide()}}function saveResults(a,b){var c=CommonHelper.FormatDate(new Date(),true);var d=DataStorageHelper.ReadLocal(ResultsKeysKey)||[];d.push(c);DataStorageHelper.SaveLocal(c,{values:b,groups:a});DataStorageHelper.SaveLocal(ResultsKeysKey,d);fillPreviousResultsMenu()}function loadResults(a){var b=DataStorageHelper.ReadLocal(a);$(".mode-label.active").removeClass("active");$(".values-switch[data-list-name='other']").prop("checked",true).change().closest(".mode-label").addClass("active");showValues(b.values);showResults(b.groups)}function removeAllSavedResults(){var a=DataStorageHelper.ReadLocal(ResultsKeysKey)||[];$.each(a,function(b,c){DataStorageHelper.RemoveLocal(c)});DataStorageHelper.RemoveLocal(ResultsKeysKey);fillPreviousResultsMenu()}function removeSavedResult(b,a){var c=DataStorageHelper.ReadLocal(ResultsKeysKey)||[];CommonHelper.RemoveFromArray(c,a);DataStorageHelper.SaveLocal(ResultsKeysKey,c);DataStorageHelper.RemoveLocal(a);b.prev().remove();b.remove()}function draw(){var c=getDistinctValues();var b=parseInt($(".number-of-groups").val());CommonHelper.ShuffleArray(c);var a=CommonHelper.SplitIntoGroups(c,b);saveResults(a,getValues());showResults(a)}function showResults(a){var b=$(".results");var e="";if(a.length>0){e+="<button type='button' class='btn btn-copy-all' title='Копировать все'></button>";e+="<button type='button' class='btn btn-download-csv' title='Экспорт в CSV'></button>";var d,c;for(d=0;d<a.length;d++){e+="<div class='result-group col'><ul class='list-group'>";for(c=0;c<a[d].length;c++){e+="<li class='list-group-item'>"+a[d][c]+"</li>"}e+="</ul><button type='button' class='btn btn-copy-group' title='Копировать'></button></div>"}}b.html(e)};